# Generating data using simstudy methods

In this chapter we will look at how to generate synthetic data on the client side using DataSHIELD functions to extract characteristics of the data set from the server side.

Again we need to build a login object for the server that holds the data:

```{r log in object simstudy}
builder <- DSI::newDSLoginBuilder()
# hide credentials
builder$append(server="server1", url="https://opal-sandbox.mrc-epid.cam.ac.uk",
               user="dsuser", password="password", 
               table = "DASIM.DASIM1")
logindata <- builder$build()
```

And then we establish a connection to the server:

```{r log in simstudy}
library(DSOpal)
if(exists("connections")){
  datashield.logout(conns = connections)
}
connections <- datashield.login(logins=logindata, assign = TRUE)
```
This method builds on the fundamentals of the **simstudy** package. There is a good introduction to this package [here](https://kgoldfeld.github.io/simstudy/index.html).

First we load the library
```{r simstudy}
library("simstudy")
library("dsBaseClient")
```

Then we can extract some parameters from the real data using DataSHIELD commands and use these to generate our synthetic data.

We will look at the binary variables first, and get the probabilities for 0/1:

```{r bin probs}
factor_vars = c("DIS_CVA", "DIS_DIAB", "DIS_AMI" )
probs = numeric()
for(var in factor_vars){
  ds.asNumeric(paste0("D$",var), newobj = paste0(var,"_num"), datasources = connections)
  probs = c(probs, ds.mean(paste0(var,"_num"), datasources = connections)$Mean.by.Study[1])
}
```

Now we use **simstudy** to generate the binary variables:

```{r bin gen}
def <- defData(varname = "GENDER", dist = "binary", 
               formula = "0.5")
def <- defData(def, varname = "DIS_CVA", dist = "binary", 
               formula = probs[1])
def <- defData(def, varname = "DIS_DIAB", dist = "binary", 
               formula = probs[2])
def <- defData(def, varname = "DIS_AMI", dist = "binary", 
               formula = probs[3])
synth_data_sim <- genData(1000, def)
```

There are some variables that we expect to be normally distributed, so we will extract the mean and standard deviation:
```{r mean sd}
columns = c("LAB_TSC", "LAB_TRIG", "LAB_HDL", "LAB_GLUC_FASTING", "PM_BMI_CONTINUOUS")
means = numeric()
sds = numeric()
for (var in columns){
  means = c(means, ds.mean(paste0("D$",var), datasources = connections)$Mean.by.Study[1])
  sds = c(sds, ds.var(paste0("D$",var), datasources = connections)$Variance.by.Study[1]^0.5)
      }
```
We can obtain the correlation matrix from DataSHIELD:

```{r corrs}
corrs = ds.cor(x="D", datasources = connections)[[1]]$`Correlation Matrix`
Dnames = ds.colnames("D")$server1
colnames(corrs) <- Dnames
rownames(corrs) <- Dnames
```

And use the correlation matrix and the properties of the normally distributed data to generate simulated data for them, adding this to the binary data we already generated:
```{r norm gen}
synth_data_sim <- addCorData(synth_data_sim, idname = "id", mu = means, sigma = sds, corMatrix = corrs[c(1:5), c(1:5)], cnames = columns)
head(synth_data_sim)
```

**TO DO** the binary data and normal data are not linked through the correlation. I wonder how this could be done to improve the realism of the data.
