<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Harmonisation with synthetic data | dsSynthetic: A DataSHIELD package to generate synthetic data</title>
  <meta name="description" content="The purpose of this book is to help the reader use dsSynthetic to help with data harmonisation and analysis when working on federated data sets with DataSHIELD" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Harmonisation with synthetic data | dsSynthetic: A DataSHIELD package to generate synthetic data" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="The purpose of this book is to help the reader use dsSynthetic to help with data harmonisation and analysis when working on federated data sets with DataSHIELD" />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Harmonisation with synthetic data | dsSynthetic: A DataSHIELD package to generate synthetic data" />
  
  <meta name="twitter:description" content="The purpose of this book is to help the reader use dsSynthetic to help with data harmonisation and analysis when working on federated data sets with DataSHIELD" />
  

<meta name="author" content="Tom Bishop, Soumya Banerjee" />


<meta name="date" content="2021-08-03" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="generating-data-using-simstudy-methods.html"/>
<link rel="next" href="analysis-with-synthetic-data.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">dsSynthetic: Synthetic data generation with DataSHIELD</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Prerequisites</a></li>
<li class="chapter" data-level="2" data-path="intro.html"><a href="intro.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="intro.html"><a href="intro.html#assumptions"><i class="fa fa-check"></i><b>2.1</b> Assumptions</a></li>
<li class="chapter" data-level="2.2" data-path="intro.html"><a href="intro.html#motivation"><i class="fa fa-check"></i><b>2.2</b> Motivation</a></li>
<li class="chapter" data-level="2.3" data-path="intro.html"><a href="intro.html#hypothesis-for-using-synthetic-data"><i class="fa fa-check"></i><b>2.3</b> Hypothesis for using synthetic data</a></li>
<li class="chapter" data-level="2.4" data-path="intro.html"><a href="intro.html#overview-of-steps"><i class="fa fa-check"></i><b>2.4</b> Overview of steps</a></li>
<li class="chapter" data-level="2.5" data-path="intro.html"><a href="intro.html#prerequisites-1"><i class="fa fa-check"></i><b>2.5</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="synthpop.html"><a href="synthpop.html"><i class="fa fa-check"></i><b>3</b> Generating data using synthpop methods</a></li>
<li class="chapter" data-level="4" data-path="generating-data-using-simstudy-methods.html"><a href="generating-data-using-simstudy-methods.html"><i class="fa fa-check"></i><b>4</b> Generating data using simstudy methods</a></li>
<li class="chapter" data-level="5" data-path="harmonisation-with-synthetic-data.html"><a href="harmonisation-with-synthetic-data.html"><i class="fa fa-check"></i><b>5</b> Harmonisation with synthetic data</a><ul>
<li class="chapter" data-level="5.1" data-path="harmonisation-with-synthetic-data.html"><a href="harmonisation-with-synthetic-data.html#getting-set-up"><i class="fa fa-check"></i><b>5.1</b> Getting set up</a></li>
<li class="chapter" data-level="5.2" data-path="harmonisation-with-synthetic-data.html"><a href="harmonisation-with-synthetic-data.html#do-the-work"><i class="fa fa-check"></i><b>5.2</b> Do the work</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="analysis-with-synthetic-data.html"><a href="analysis-with-synthetic-data.html"><i class="fa fa-check"></i><b>6</b> Analysis with synthetic data</a><ul>
<li class="chapter" data-level="6.1" data-path="analysis-with-synthetic-data.html"><a href="analysis-with-synthetic-data.html#getting-set-up-1"><i class="fa fa-check"></i><b>6.1</b> Getting set up</a></li>
<li class="chapter" data-level="6.2" data-path="analysis-with-synthetic-data.html"><a href="analysis-with-synthetic-data.html#create-synthetic-dataset"><i class="fa fa-check"></i><b>6.2</b> Create synthetic dataset</a></li>
<li class="chapter" data-level="6.3" data-path="analysis-with-synthetic-data.html"><a href="analysis-with-synthetic-data.html#start-dslite-local-instance"><i class="fa fa-check"></i><b>6.3</b> Start DSLite local instance</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">dsSynthetic: A DataSHIELD package to generate synthetic data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="harmonisation-with-synthetic-data" class="section level1">
<h1><span class="header-section-number">Chapter 5</span> Harmonisation with synthetic data</h1>
<p>In this section we describe how to harmonise synthetic data on the client side. This assumes that you have used one of the previous methods to generate your synthetic data set.</p>
<p>Recall that we are aiming to use synthetic data on the client side to design harmonisation algorithms, and then implement these on Opal on the server side using the real data. This removes the need for the user to have full access to the data. Harmonisation algorithms can be implemented in Opal using MagmaScript (JavaScript) without having full access to the data. The idea is that writing JavaScript on the client side, having full access to the synthetic data, is easier than writing the code on the server side with only access to summaries.</p>
<p>In detail, the steps proposed are:</p>
<ol style="list-style-type: decimal">
<li>Start a JavaScript session on the client side</li>
<li>Load the synthetic data into the session</li>
<li>Write and test JavaScript code in the session against the synthetic data</li>
<li>When happy, copy the code into Opal to generate the harmonised data</li>
</ol>
<div id="getting-set-up" class="section level2">
<h2><span class="header-section-number">5.1</span> Getting set up</h2>
<p>First some system level packages may need to be installed: On Debian / Ubuntu install either <code>libv8-dev</code> or <code>libnode-dev</code>, on Fedora use <code>v8-devel</code>.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="harmonisation-with-synthetic-data.html#cb32-1"></a><span class="kw">install.packages</span>(<span class="st">&quot;V8&quot;</span>)</span></code></pre></div>
<pre><code>## Installing package into &#39;/home/vagrant/R/x86_64-pc-linux-gnu-library/4.0&#39;
## (as &#39;lib&#39; is unspecified)</code></pre>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="harmonisation-with-synthetic-data.html#cb34-1"></a><span class="kw">library</span>(<span class="st">&quot;V8&quot;</span>)</span></code></pre></div>
<pre><code>## Using V8 engine 6.8.275.32-node.12</code></pre>
</div>
<div id="do-the-work" class="section level2">
<h2><span class="header-section-number">5.2</span> Do the work</h2>
<p>Now we can start a JavaScript session and load the additional MagmaScript functionality:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="harmonisation-with-synthetic-data.html#cb36-1"></a>ct2 =<span class="st"> </span><span class="kw">v8</span>()</span>
<span id="cb36-2"><a href="harmonisation-with-synthetic-data.html#cb36-2"></a>ct2<span class="op">$</span><span class="kw">source</span>(<span class="st">&quot;https://raw.githubusercontent.com/tombisho/dsSyntheticClient/main/MagmaScript.min.js&quot;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;true&quot;</code></pre>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="harmonisation-with-synthetic-data.html#cb38-1"></a>synth_data =<span class="st"> </span><span class="kw">read.csv</span>(<span class="dt">file =</span> <span class="st">&quot;data/synth_data.csv&quot;</span>)</span>
<span id="cb38-2"><a href="harmonisation-with-synthetic-data.html#cb38-2"></a>ct2<span class="op">$</span><span class="kw">assign</span>(<span class="st">&quot;synth_data&quot;</span>, synth_data)</span></code></pre></div>
<p>We then go into the console, grab a row of data and write some JavaScript:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="harmonisation-with-synthetic-data.html#cb39-1"></a>ct2<span class="op">$</span><span class="kw">console</span>()</span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb40-1"><a href="harmonisation-with-synthetic-data.html#cb40-1"></a><span class="kw">var</span> $ <span class="op">=</span> <span class="va">MagmaScript</span>.<span class="va">MagmaScript</span>.<span class="va">$</span>.<span class="at">bind</span>(als_syn[<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb40-2"><a href="harmonisation-with-synthetic-data.html#cb40-2"></a></span>
<span id="cb40-3"><a href="harmonisation-with-synthetic-data.html#cb40-3"></a><span class="cf">if</span> (<span class="at">$</span>(<span class="st">&#39;y3age&#39;</span>).<span class="at">value</span>() <span class="op">&gt;</span> <span class="dv">25</span> )<span class="op">{</span></span>
<span id="cb40-4"><a href="harmonisation-with-synthetic-data.html#cb40-4"></a>  out <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb40-5"><a href="harmonisation-with-synthetic-data.html#cb40-5"></a><span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb40-6"><a href="harmonisation-with-synthetic-data.html#cb40-6"></a>  out <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb40-7"><a href="harmonisation-with-synthetic-data.html#cb40-7"></a><span class="op">}</span></span></code></pre></div>
<p>Now we test our code against the whole dataset:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb41-1"><a href="harmonisation-with-synthetic-data.html#cb41-1"></a></span>
<span id="cb41-2"><a href="harmonisation-with-synthetic-data.html#cb41-2"></a>myScript <span class="op">=</span> <span class="vs">`</span></span>
<span id="cb41-3"><a href="harmonisation-with-synthetic-data.html#cb41-3"></a><span class="vs">if ($(&#39;y3age&#39;).value() &gt; 25 ){</span></span>
<span id="cb41-4"><a href="harmonisation-with-synthetic-data.html#cb41-4"></a><span class="vs">  out = 1</span></span>
<span id="cb41-5"><a href="harmonisation-with-synthetic-data.html#cb41-5"></a><span class="vs">} else {</span></span>
<span id="cb41-6"><a href="harmonisation-with-synthetic-data.html#cb41-6"></a><span class="vs">  out = 0</span></span>
<span id="cb41-7"><a href="harmonisation-with-synthetic-data.html#cb41-7"></a><span class="vs">}</span></span>
<span id="cb41-8"><a href="harmonisation-with-synthetic-data.html#cb41-8"></a><span class="vs">`</span></span>
<span id="cb41-9"><a href="harmonisation-with-synthetic-data.html#cb41-9"></a></span>
<span id="cb41-10"><a href="harmonisation-with-synthetic-data.html#cb41-10"></a><span class="kw">var</span> my_out <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb41-11"><a href="harmonisation-with-synthetic-data.html#cb41-11"></a></span>
<span id="cb41-12"><a href="harmonisation-with-synthetic-data.html#cb41-12"></a><span class="cf">for</span> (j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> <span class="va">als_syn</span>.<span class="at">length</span><span class="op">;</span> j<span class="op">++</span>)<span class="op">{</span></span>
<span id="cb41-13"><a href="harmonisation-with-synthetic-data.html#cb41-13"></a>  <span class="va">my_out</span>.<span class="at">push</span>(<span class="va">MagmaScript</span>.<span class="at">evaluator</span>(myScript<span class="op">,</span> als_syn[j]))</span>
<span id="cb41-14"><a href="harmonisation-with-synthetic-data.html#cb41-14"></a><span class="op">}</span></span>
<span id="cb41-15"><a href="harmonisation-with-synthetic-data.html#cb41-15"></a>exit</span></code></pre></div>
<p>And pull the results into R for inspection:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="harmonisation-with-synthetic-data.html#cb42-1"></a>my_out =<span class="st"> </span>ct2<span class="op">$</span><span class="kw">get</span>(<span class="st">&quot;my_out&quot;</span>)</span>
<span id="cb42-2"><a href="harmonisation-with-synthetic-data.html#cb42-2"></a></span>
<span id="cb42-3"><a href="harmonisation-with-synthetic-data.html#cb42-3"></a>synth_data_harm =<span class="st"> </span>synth_data</span>
<span id="cb42-4"><a href="harmonisation-with-synthetic-data.html#cb42-4"></a>synth_data_harm<span class="op">$</span>my_var =<span class="st"> </span>my_out</span></code></pre></div>
<p>If we are happy with the code, we can paste it directly into the Opal <em>script</em> interface so that it can be executed on the real data.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="generating-data-using-simstudy-methods.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="analysis-with-synthetic-data.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["synthetic_bookdown.pdf", "synthetic_bookdown.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
